<!-- templates/dashboard.html - FIXED FOR FILE-BASED SESSION STORAGE -->
{% extends "base.html" %}

{% block title %}Dashboard - Route Analytics Pro{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">Route Analytics Dashboard</h2>
                <div class="text-muted mt-1">Upload CSV coordinates to analyze routes with real-time data</div>
            </div>
        </div>
    </div>
</div>

<div class="row row-deck row-cards">
    <!-- Upload Section -->
    <div class="col-12">
        <div class="card route-card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    Upload Route CSV
                </h3>
            </div>
            <div class="card-body">
                <div id="upload-area" class="upload-area" onclick="document.getElementById('csv_file').click()">
                    <div class="upload-icon mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </div>
                    <h4>Drag & Drop CSV File or Click to Browse</h4>
                    <p class="text-muted">Upload CSV file with latitude,longitude columns</p>
                    <small class="text-muted">Supports files up to 16MB</small>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data" style="display: none;">
                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                </form>
                
                <div id="upload-progress" style="display: none;" class="mt-3">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Analyzing route with real-time data...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Results - FIXED TO CHECK has_route_data -->
    {% if session.has_route_data %}
    <div class="col-12">
        <div class="card success-card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                    Route Analysis Complete
                </h3>
                <div class="card-actions">
                    <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                            <polyline points="7,10 12,15 17,10"/>
                        </svg>
                        Download PDF Report
                    </a>
                    <a href="{{ url_for('route_details') }}" class="btn btn-outline-primary ms-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        View Details
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-success" role="alert">
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="alert-title">Analysis Complete!</h4>
                            <div class="text-muted">
                                Your route has been successfully analyzed with real-time data including network coverage, weather conditions, sharp turns, and points of interest.
                                {% if session.analysis_timestamp %}
                                <br><small>Analysis completed: {{ session.analysis_timestamp[:19].replace('T', ' at ') }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üìä</div>
                                <div class="text-muted">Complete Analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üó∫Ô∏è</div>
                                <div class="text-muted">Interactive Maps</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üì°</div>
                                <div class="text-muted">Network Coverage</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üìÑ</div>
                                <div class="text-muted">PDF Report</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="mt-4 text-center">
                    <div class="btn-list">
                        <a href="{{ url_for('route_details') }}" class="btn btn-outline-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            View Analysis Details
                        </a>
                        <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                                <polyline points="7,10 12,15 17,10"/>
                            </svg>
                            Download Full Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Instructions when no route data -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <path d="M12 17h.01"/>
                    </svg>
                    How to Use Route Analytics Pro
                </h3>
            </div>
            <div class="card-body">
                <div class="steps">
                    <div class="step-item">
                        <div class="h4">1. Prepare CSV File</div>
                        <div class="text-muted">Create a CSV file with latitude and longitude columns (decimal format)</div>
                        <div class="text-muted mt-1">
                            <small><strong>Example format:</strong></small><br>
                            <code>28.94966,77.65908<br>28.95012,77.65923<br>28.95045,77.65941</code>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="h4">2. Upload & Analyze</div>
                        <div class="text-muted">Upload your CSV file and wait for comprehensive real-time route analysis</div>
                        <div class="text-muted mt-1">
                            <small><strong>Analysis includes:</strong> Sharp turns, weather, network coverage, POIs, elevation</small>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="h4">3. Review Results</div>
                        <div class="text-muted">View interactive maps, detailed analysis, and download comprehensive PDF report</div>
                        <div class="text-muted mt-1">
                            <small><strong>Features:</strong> Network coverage maps, hazard locations, safety recommendations</small>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Data Section -->
                <div class="mt-4">
                    <h4>Sample CSV Format</h4>
                    <div class="card">
                        <div class="card-body p-3">
                            <pre><code>28.94966,77.65908
28.95012,77.65923  
28.95045,77.65941
28.95078,77.65959
28.95112,77.65978</code></pre>
                            <div class="text-muted mt-2">
                                <small>Each row should contain: <strong>latitude,longitude</strong> (no headers required)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Features Overview -->
                <div class="mt-4">
                    <h4>Analysis Features</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><strong>Sharp Turn Analysis</strong> - Identify dangerous curves and blind spots</li>
                                <li><strong>Network Coverage</strong> - Real-time cellular coverage analysis</li>
                                <li><strong>Weather Conditions</strong> - Current weather along the route</li>
                                <li><strong>Points of Interest</strong> - Hospitals, fuel stations, schools</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><strong>Interactive Maps</strong> - Complete route visualization</li>
                                <li><strong>Safety Recommendations</strong> - Personalized driving advice</li>
                                <li><strong>PDF Reports</strong> - Comprehensive analysis documents</li>
                                <li><strong>Risk Assessment</strong> - Route safety scoring</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- System Status -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6"/>
                        <path d="m21 12-6 0m-6 0-6 0"/>
                    </svg>
                    System Status
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Route Analysis</div>
                                <div class="text-muted small">Active</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Network Coverage</div>
                                <div class="text-muted small">Real-time API</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Google Maps</div>
                                <div class="text-muted small">Connected</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Weather Data</div>
                                <div class="text-muted small">Available</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('csv_file');
    const uploadForm = document.getElementById('upload-form');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileUpload();
        }
    });
    
    // File input change handler
    fileInput.addEventListener('change', handleFileUpload);
    
    function handleFileUpload() {
        const file = fileInput.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file');
            return;
        }
        
        const formData = new FormData();
        formData.append('csv_file', file);
        
        // Show progress
        progressDiv.style.display = 'block';
        uploadArea.style.display = 'none';
        
        // Simulate progress for user feedback
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);
        
        // Upload file
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            if (data.status === 'success') {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success mt-3';
                successMsg.innerHTML = `
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="alert-title">Analysis Complete!</h4>
                            <div class="text-muted">${data.message}</div>
                        </div>
                    </div>
                `;
                progressDiv.appendChild(successMsg);
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                alert('Error: ' + (data.error || 'Upload failed'));
                resetUploadArea();
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);
            alert('Upload failed: ' + error.message);
            resetUploadArea();
        });
    }
    
    function resetUploadArea() {
        setTimeout(() => {
            progressDiv.style.display = 'none';
            uploadArea.style.display = 'block';
            progressBar.style.width = '0%';
        }, 2000);
    }
});
</script>
{% endblock %}