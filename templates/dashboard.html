<!-- templates/dashboard.html - ENHANCED WITH VIEW PREVIOUS ANALYSIS -->
{% extends "base.html" %}

{% block title %}Enhanced Dashboard - Route Analytics Pro{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">Enhanced Route Analytics Dashboard</h2>
                <div class="text-muted mt-1">Upload CSV coordinates to analyze routes with comprehensive mapping and real-time network data</div>
            </div>
        </div>
    </div>
</div>

<div class="row row-deck row-cards">
    <!-- Upload Section -->
    <div class="col-12">
        <div class="card route-card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    Upload Route CSV for New Analysis
                </h3>
            </div>
            <div class="card-body">
                <div id="upload-area" class="upload-area" onclick="document.getElementById('csv_file').click()">
                    <div class="upload-icon mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </div>
                    <h4>Drag & Drop CSV File or Click to Browse</h4>
                    <p class="text-muted">Upload CSV file with latitude,longitude columns for comprehensive analysis</p>
                    <div class="mt-2">
                        <span class="badge bg-success">NEW: Comprehensive Maps</span>
                        <span class="badge bg-info">NEW: Network Coverage</span>
                        <span class="badge bg-warning">Enhanced: All POIs Mapped</span>
                    </div>
                    <small class="text-muted">Supports files up to 16MB</small>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data" style="display: none;">
                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                </form>
                
                <div id="upload-progress" style="display: none;" class="mt-3">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Analyzing route with enhanced mapping and real-time network data...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ENHANCEMENT 3: View Previous Analysis Section -->
    {% if session.has_route_data %}
    <div class="col-12">
        <div class="card success-card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Previous Route Analysis Available
                </h3>
                <div class="card-actions">
                    <a href="{{ url_for('route_details') }}" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        View Previous Analysis
                    </a>
                    <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-primary ms-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                            <polyline points="7,10 12,15 17,10"/>
                        </svg>
                        Download Enhanced PDF
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-success" role="alert">
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="alert-title">Enhanced Analysis Available!</h4>
                            <div class="text-muted">
                                Your route has been analyzed with enhanced features including comprehensive mapping,
                                real-time network coverage analysis, and detailed POI visualization.
                                {% if session.analysis_timestamp %}
                                <br><small>Analysis completed: {{ session.analysis_timestamp[:19].replace('T', ' at ') }}</small>
                                {% endif %}
                                {% if session.uploaded_file %}
                                <br><small>File analyzed: {{ session.uploaded_file }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Features Overview -->
                <div class="row">
                    <div class="col-md-2">
                        <div class="card bg-primary-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üó∫Ô∏è</div>
                                <div class="text-muted small">Comprehensive Map</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-info-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üì°</div>
                                <div class="text-muted small">Network Coverage</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-warning-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">‚ö†Ô∏è</div>
                                <div class="text-muted small">Hazard Analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-success-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üè•</div>
                                <div class="text-muted small">POI Mapping</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-teal-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üìä</div>
                                <div class="text-muted small">Safety Analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-purple-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">üìÑ</div>
                                <div class="text-muted small">Enhanced PDF</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="mt-4 text-center">
                    <div class="btn-list justify-content-center">
                        <a href="{{ url_for('route_details') }}" class="btn btn-outline-success btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            View Enhanced Analysis
                        </a>
                        <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-primary btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                                <polyline points="7,10 12,15 17,10"/>
                            </svg>
                            Download Enhanced PDF Report
                        </a>
                        <button onclick="clearPreviousAnalysis()" class="btn btn-outline-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                            Clear & Start New
                        </button>
                    </div>
                </div>

                <!-- Analysis Summary Preview -->
                <div class="mt-4">
                    <h5>Analysis Summary Preview:</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Route Information</div>
                                    </div>
                                    <div class="h3 m-0">Available</div>
                                    <div class="text-muted">Distance, duration & waypoints mapped</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Safety Analysis</div>
                                    </div>
                                    <div class="h3 m-0">Complete</div>
                                    <div class="text-muted">Hazards identified & mapped</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Network Coverage</div>
                                    </div>
                                    <div class="h3 m-0">Real-time</div>
                                    <div class="text-muted">Live coverage data analyzed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Instructions when no route data -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <path d="M12 17h.01"/>
                    </svg>
                    How to Use Enhanced Route Analytics Pro
                </h3>
            </div>
            <div class="card-body">
                <div class="steps">
                    <div class="step-item">
                        <div class="h4">1. Prepare CSV File</div>
                        <div class="text-muted">Create a CSV file with latitude and longitude columns (decimal format)</div>
                        <div class="text-muted mt-1">
                            <small><strong>Example format:</strong></small><br>
                            <code>28.94966,77.65908<br>28.95012,77.65923<br>28.95045,77.65941</code>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="h4">2. Upload & Analyze</div>
                        <div class="text-muted">Upload your CSV file for comprehensive real-time route analysis with enhanced mapping</div>
                        <div class="text-muted mt-1">
                            <small><strong>Enhanced analysis includes:</strong> Comprehensive maps, network coverage, detailed POI visualization</small>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="h4">3. View Enhanced Results</div>
                        <div class="text-muted">Explore interactive maps, detailed network analysis, and download comprehensive PDF reports</div>
                        <div class="text-muted mt-1">
                            <small><strong>New features:</strong> All-points mapping, dedicated network maps, enhanced PDF reports</small>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Features Preview -->
                <div class="mt-4">
                    <h4>Enhanced Analysis Features</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><strong>üó∫Ô∏è Comprehensive Route Map</strong> - All points marked with color-coded markers</li>
                                <li><strong>üì° Dedicated Network Coverage Map</strong> - Real-time cellular coverage analysis</li>
                                <li><strong>‚ö†Ô∏è Enhanced Hazard Analysis</strong> - Sharp turns, blind spots with severity levels</li>
                                <li><strong>üè• Complete POI Visualization</strong> - Hospitals, fuel, schools, food mapped</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><strong>üìä Safety Scoring System</strong> - Overall route safety rating</li>
                                <li><strong>üéØ Interactive Maps</strong> - Complete route visualization with all markers</li>
                                <li><strong>üìÑ Enhanced PDF Reports</strong> - Comprehensive documentation with maps</li>
                                <li><strong>üîÑ Previous Analysis Access</strong> - View results without re-calculation</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Data Section -->
                <div class="mt-4">
                    <h4>Sample CSV Format</h4>
                    <div class="card">
                        <div class="card-body p-3">
                            <pre><code>28.94966,77.65908
28.95012,77.65923  
28.95045,77.65941
28.95078,77.65959
28.95112,77.65978</code></pre>
                            <div class="text-muted mt-2">
                                <small>Each row should contain: <strong>latitude,longitude</strong> (no headers required)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Features Highlight -->
                <div class="mt-4">
                    <div class="card bg-primary-lt">
                        <div class="card-body">
                            <h4 class="text-primary">üÜï Latest Enhancements</h4>
                          <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center p-3">
                                        <div class="h2 text-primary">üó∫Ô∏è</div>
                                        <h5>Comprehensive Maps</h5>
                                        <p class="text-muted small">All route points marked with color-coded markers for hazards, POIs, and network coverage</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center p-3">
                                        <div class="h2 text-info">üì°</div>
                                        <h5>Network Coverage Maps</h5>
                                        <p class="text-muted small">Dedicated maps showing real-time cellular coverage with dead zones and poor coverage areas</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center p-3">
                                        <div class="h2 text-success">üîÑ</div>
                                        <h5>Previous Analysis Access</h5>
                                        <p class="text-muted small">View previously analyzed routes without re-calculation, instant access to results</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- System Status with Enhanced Features -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6"/>
                        <path d="m21 12-6 0m-6 0-6 0"/>
                    </svg>
                    Enhanced System Status
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Route Analysis</div>
                                <div class="text-muted small">Enhanced Active</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Network Coverage</div>
                                <div class="text-muted small">Real-time API</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Comprehensive Maps</div>
                                <div class="text-muted small">All Points Mapping</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Google Maps</div>
                                <div class="text-muted small">Enhanced Integration</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Weather Data</div>
                                <div class="text-muted small">Multi-point Analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator bg-success me-2"></span>
                            <div>
                                <div class="font-weight-medium">Enhanced PDF</div>
                                <div class="text-muted small">Comprehensive Reports</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Tips for Enhanced Features -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Pro Tips for Enhanced Analysis
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <h5 class="text-primary">üó∫Ô∏è Comprehensive Mapping</h5>
                                <ul class="small">
                                    <li>All hazards marked with color-coded markers</li>
                                    <li>POIs distributed along route path</li>
                                    <li>Elevation points highlighted</li>
                                    <li>Start/end points clearly marked</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <h5 class="text-info">üì° Network Coverage</h5>
                                <ul class="small">
                                    <li>Real-time cellular coverage testing</li>
                                    <li>Dead zones identified and mapped</li>
                                    <li>Poor coverage areas highlighted</li>
                                    <li>Signal quality visualization</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <h5 class="text-success">üîÑ Previous Analysis</h5>
                                <ul class="small">
                                    <li>Instant access to previous results</li>
                                    <li>No need to re-upload or re-calculate</li>
                                    <li>View detailed analysis anytime</li>
                                    <li>Download enhanced PDF reports</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('csv_file');
    const uploadForm = document.getElementById('upload-form');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileUpload();
        }
    });
    
    // File input change handler
    fileInput.addEventListener('change', handleFileUpload);
    
    function handleFileUpload() {
        const file = fileInput.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file');
            return;
        }
        
        const formData = new FormData();
        formData.append('csv_file', file);
        
        // Show progress
        progressDiv.style.display = 'block';
        uploadArea.style.display = 'none';
        
        // Enhanced progress simulation with more detailed messages
        let progress = 0;
        let progressMessages = [
            'Uploading CSV file...',
            'Processing route coordinates...',
            'Analyzing sharp turns and hazards...',
            'Testing network coverage at route points...',
            'Finding points of interest...',
            'Generating comprehensive maps...',
            'Creating enhanced analysis...',
            'Finalizing results...'
        ];
        let messageIndex = 0;
        
        const progressInterval = setInterval(() => {
            progress += Math.random() * 12;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            
            // Update progress message
            if (messageIndex < progressMessages.length - 1 && progress > (messageIndex + 1) * 12) {
                messageIndex++;
                const messageElement = progressDiv.querySelector('.text-muted');
                messageElement.textContent = progressMessages[messageIndex];
            }
        }, 600);
        
        // Upload file
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            const messageElement = progressDiv.querySelector('.text-muted');
            
            if (data.status === 'success') {
                messageElement.textContent = 'Enhanced analysis complete!';
                
                // Show enhanced success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success mt-3';
                successMsg.innerHTML = `
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="alert-title">Enhanced Analysis Complete!</h4>
                            <div class="text-muted">
                                ${data.message}
                                <br><strong>New Features Available:</strong>
                                <br>‚Ä¢ Comprehensive route map with all points marked
                                <br>‚Ä¢ Dedicated network coverage analysis and mapping
                                <br>‚Ä¢ Enhanced PDF report with detailed visualizations
                            </div>
                        </div>
                    </div>
                `;
                progressDiv.appendChild(successMsg);
                
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                messageElement.textContent = 'Analysis failed!';
                alert('Error: ' + (data.error || 'Upload failed'));
                resetUploadArea();
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);
            alert('Upload failed: ' + error.message);
            resetUploadArea();
        });
    }
    
    function resetUploadArea() {
        setTimeout(() => {
            progressDiv.style.display = 'none';
            uploadArea.style.display = 'block';
            progressBar.style.width = '0%';
        }, 2000);
    }
});

// ENHANCEMENT 3: Clear previous analysis function
function clearPreviousAnalysis() {
    if (confirm('Are you sure you want to clear the previous analysis? This will remove all saved route data.')) {
        fetch('/clear-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible';
                alertDiv.innerHTML = `
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="alert-title">Analysis Cleared</h4>
                            <div class="text-muted">Previous route analysis has been cleared. You can now upload a new CSV file for fresh analysis.</div>
                        </div>
                    </div>
                    <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
                `;
                
                document.querySelector('.container-xl').insertBefore(alertDiv, document.querySelector('.row'));
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                alert('Error clearing analysis: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Clear analysis error:', error);
            alert('Error clearing analysis: ' + error.message);
        });
    }
}

// Enhanced file validation with size check
function validateFile(file) {
    const maxSize = 16 * 1024 * 1024; // 16MB
    const allowedTypes = ['.csv'];
    
    if (file.size > maxSize) {
        alert('File size exceeds 16MB limit. Please use a smaller file.');
        return false;
    }
    
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedTypes.includes(fileExtension)) {
        alert('Only CSV files are allowed.');
        return false;
    }
    
    return true;
}

// Add file validation to upload handler
const originalHandleFileUpload = handleFileUpload;
handleFileUpload = function() {
    const file = fileInput.files[0];
    if (!file) return;
    
    if (!validateFile(file)) {
        fileInput.value = ''; // Clear the input
        return;
    }
    
    originalHandleFileUpload();
};
</script>
{% endblock %}