<!-- templates/route_details.html - ENHANCED WITH COMPREHENSIVE MAPPING -->
{% extends "base.html" %}

{% block title %}Enhanced Route Details - Route Analytics Pro{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">Enhanced Route Analysis Details</h2>
                <div class="text-muted mt-1">Comprehensive analysis with enhanced mapping, network coverage, and real-time data visualization</div>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <a href="{{ url_for('generate_pdf_report') }}" class="btn btn-primary btn-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                            <polyline points="7,10 12,15 17,10"/>
                        </svg>
                        Download Enhanced PDF Report
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row row-deck row-cards">
    <!-- Enhanced Route Overview -->
    <div class="col-12">
        <div class="card route-card">
            <div class="card-header">
                <h3 class="card-title">Enhanced Route Overview</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>From:</strong></td>
                                <td>{{ route_data.from_address }}</td>
                            </tr>
                            <tr>
                                <td><strong>To:</strong></td>
                                <td>{{ route_data.to_address }}</td>
                            </tr>
                            <tr>
                                <td><strong>Distance:</strong></td>
                                <td>{{ route_data.distance }}</td>
                            </tr>
                            <tr>
                                <td><strong>Duration:</strong></td>
                                <td>{{ route_data.duration }}</td>
                            </tr>
                            <tr>
                                <td><strong>Route Points:</strong></td>
                                <td>{{ route_data.total_points }} coordinates analyzed</td>
                            </tr>
                            <tr>
                                <td><strong>Safety Score:</strong></td>
                                <td>
                                    <span class="badge bg-{% if route_data.enhanced_stats.safety_score >= 85 %}success{% elif route_data.enhanced_stats.safety_score >= 70 %}warning{% else %}danger{% endif %}">
                                        {{ route_data.enhanced_stats.safety_score }}/100
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="card bg-danger-lt">
                                    <div class="card-body p-2 text-center">
                                        <div class="h2 m-0">{{ route_data.enhanced_stats.blind_spots_count }}</div>
                                        <div class="text-muted small">Blind Spots (>80°)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-warning-lt">
                                    <div class="card-body p-2 text-center">
                                        <div class="h2 m-0">{{ route_data.network_coverage.dead_zones|length }}</div>
                                        <div class="text-muted small">Network Dead Zones</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-info-lt">
                                    <div class="card-body p-2 text-center">
                                        <div class="h2 m-0">{{ route_data.weather|length }}</div>
                                        <div class="text-muted small">Weather Points</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-success-lt">
                                    <div class="card-body p-2 text-center">
                                        {% set poi_count = (route_data.petrol_bunks|length) + (route_data.hospitals|length) + (route_data.schools|length) + (route_data.food_stops|length) %}
                                        <div class="h2 m-0">{{ poi_count }}</div>
                                        <div class="text-muted small">Total POIs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCEMENT 1: Comprehensive Route Map with ALL Points -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    🆕 COMPREHENSIVE ROUTE MAP - ALL POINTS MARKED
                </h3>
                <div class="card-actions">
                    <div class="btn-list">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleMapFullscreen('comprehensive-route-map')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                            </svg>
                            Fullscreen
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadMapImage('comprehensive-route-map')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="comprehensive-route-map" class="map-container" style="height: 500px;"></div>
                <div class="p-3">
                    <h5>Comprehensive Map Legend:</h5>
                    <div class="network-legend">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #28a745;"></div>
                                    <span><strong>Start Point</strong> - Route beginning</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #dc3545;"></div>
                                    <span><strong>End Point / Blind Spots (>80°)</strong> - EXTREME DANGER</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #fd7e14;"></div>
                                    <span><strong>Sharp Turns (70-80°)</strong> - HIGH DANGER</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #ffc107;"></div>
                                    <span><strong>Moderate Turns (45-70°)</strong> - CAUTION</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #0891b2;"></div>
                                    <span><strong>Hospitals</strong> - Emergency services</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #7c3aed;"></div>
                                    <span><strong>Fuel Stations</strong> - Petrol pumps</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #059669;"></div>
                                    <span><strong>Schools</strong> - Speed limit zones (40 km/h)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #0891b2;"></div>
                                    <span><strong>Food Stops</strong> - Restaurants/Rest areas</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #6b7280;"></div>
                                    <span><strong>Network Dead Zones</strong> - No cellular coverage</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #a855f7;"></div>
                                    <span><strong>Elevation Points</strong> - High/Low elevation areas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <strong>🆕 Enhanced Feature:</strong> This comprehensive map shows ALL analyzed points with color-coded markers. 
                            Each marker type represents different safety considerations, services, and network coverage areas along your route.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCEMENT 2: Dedicated Network Coverage Map -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                        <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                        <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                        <path d="M12 20h.01"/>
                    </svg>
                    🆕 DEDICATED NETWORK COVERAGE MAP - REAL-TIME DATA
                </h3>
                <div class="card-actions">
                    <div class="btn-list">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleMapFullscreen('network-coverage-map')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                            </svg>
                            Fullscreen
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="refreshNetworkData()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/>
                                <path d="M12 3v9l3 3"/>
                            </svg>
                            Real-time Data
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% set coverage_stats = route_data.network_coverage.coverage_stats %}
                
                <!-- Network Coverage Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">{{ coverage_stats.api_success_rate|round(1) }}%</div>
                                <div class="text-muted">API Success Rate</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">{{ coverage_stats.overall_coverage_score|round(1) }}</div>
                                <div class="text-muted">Coverage Score</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">{{ route_data.network_coverage.dead_zones|length }}</div>
                                <div class="text-muted">Dead Zones</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning-lt">
                            <div class="card-body text-center p-3">
                                <div class="h2 m-0">{{ route_data.network_coverage.poor_zones|length }}</div>
                                <div class="text-muted">Poor Coverage</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dedicated Network Coverage Map -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Real-Time Network Coverage Visualization</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="network-coverage-map" class="map-container" style="height: 500px;"></div>
                        <div class="p-3">
                            <h5>Network Coverage Legend:</h5>
                            <div class="network-legend">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="legend-item">
                                            <div class="legend-color coverage-excellent"></div>
                                            <span><strong>Excellent Coverage</strong> - Full connectivity (>-70 dBm)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color coverage-good"></div>
                                            <span><strong>Good Coverage</strong> - Reliable connectivity (-70 to -85 dBm)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color coverage-fair"></div>
                                            <span><strong>Fair Coverage</strong> - Adequate connectivity (-85 to -100 dBm)</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="legend-item">
                                            <div class="legend-color coverage-poor"></div>
                                            <span><strong>Poor Coverage</strong> - Unreliable connectivity (-100 to -110 dBm)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color coverage-dead"></div>
                                            <span><strong>Dead Zones</strong> - No connectivity (<-110 dBm)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #6b7280;"></div>
                                            <span><strong>API Failed</strong> - Coverage data unavailable</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <strong>🆕 Real-Time Feature:</strong> This dedicated network map shows actual cellular coverage data 
                                    obtained from live network APIs. Each marker represents a real coverage test point along your route.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coverage Quality Distribution -->
                {% if coverage_stats.quality_distribution %}
                <div class="mt-4">
                    <h4>Signal Quality Distribution Analysis</h4>
                    <div class="row">
                        {% for quality, count in coverage_stats.quality_distribution.items() %}
                        {% if count > 0 %}
                        <div class="col-md-2 mb-2">
                            <div class="card coverage-{{ quality }}">
                                <div class="card-body text-center p-2">
                                    <div class="h4 m-0">{{ count }}</div>
                                    <div class="small">{{ quality.title() }}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Technology Availability -->
                {% if coverage_stats.technology_availability %}
                <div class="mt-4">
                    <h4>Technology Availability Along Route</h4>
                    <div class="row">
                        {% for tech, count in coverage_stats.technology_availability.items() %}
                        {% if count > 0 %}
                        <div class="col-md-3 mb-2">
                            <div class="card bg-info-lt">
                                <div class="card-body text-center p-2">
                                    <div class="h4 m-0">{{ count }}</div>
                                    <div class="small">{{ tech }} Points</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Continue with other existing sections... -->
    <!-- (Sharp Turns Analysis, Weather Conditions, POIs, etc.) -->
     <!-- Sharp Turns Analysis -->
    <div class="col-md-6">
        <div class="card danger-card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                    </svg>
                    Critical Sharp Turns ({{ route_data.sharp_turns|length }})
                </h3>
            </div>
            <div class="card-body">
                {% if route_data.sharp_turns %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Angle</th>
                                <th>Classification</th>
                                <th>Coordinates</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for turn in route_data.sharp_turns[:10] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <span class="badge bg-{% if turn.angle > 80 %}danger{% elif turn.angle > 70 %}warning{% else %}secondary{% endif %}">
                                        {{ turn.angle }}°
                                    </span>
                                </td>
                                <td>{{ turn.classification }}</td>
                                <td><small>{{ "%.4f, %.4f"|format(turn.lat, turn.lng) }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if route_data.sharp_turns|length > 10 %}
                <div class="text-muted text-center">
                    <small>... and {{ route_data.sharp_turns|length - 10 }} more turns in enhanced PDF report</small>
                </div>
                {% endif %}
                {% else %}
                <div class="empty">
                    <div class="empty-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </div>
                    <p class="empty-title">No Critical Sharp Turns</p>
                    <p class="empty-subtitle text-muted">This route appears to have safe turning angles.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Weather Conditions -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                    </svg>
                    Weather Conditions ({{ route_data.weather|length }})
                </h3>
            </div>
            <div class="card-body">
                {% if route_data.weather %}
                <div class="row g-2">
                    {% for weather in route_data.weather %}
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ weather.location }}</strong>
                                        <div class="text-muted small">{{ weather.description.title() }}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h4 m-0 {% if weather.temp > 35 %}text-danger{% elif weather.temp < 10 %}text-info{% endif %}">
                                            {{ weather.temp }}°C
                                        </div>
                                        <div class="small text-muted">{{ weather.humidity }}% humidity</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty">
                    <div class="empty-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                        </svg>
                    </div>
                    <p class="empty-title">No Weather Data</p>
                    <p class="empty-subtitle text-muted">Weather information not available for this route.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Points of Interest -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Points of Interest Along Route
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Hospitals -->
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title text-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                        <path d="M12 5L8 21l4-7 4 7-4-16"/>
                                    </svg>
                                    Hospitals ({{ route_data.hospitals|length }})
                                </h4>
                            </div>
                            <div class="card-body p-2">
                                {% if route_data.hospitals %}
                                {% for name, location in route_data.hospitals.items() %}
                                {% if loop.index <= 5 %}
                                <div class="mb-2">
                                    <div class="small fw-bold">{{ name[:30] }}{% if name|length > 30 %}...{% endif %}</div>
                                    <div class="text-muted small">{{ location[:40] }}{% if location|length > 40 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% if route_data.hospitals|length > 5 %}
                                <div class="text-muted small">... and {{ route_data.hospitals|length - 5 }} more</div>
                                {% endif %}
                                {% else %}
                                <div class="text-muted small">None found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Fuel Stations -->
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title text-warning">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <line x1="3" y1="22" x2="15" y2="22"/>
                                        <line x1="4" y1="9" x2="14" y2="9"/>
                                        <path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/>
                                        <path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2"/>
                                    </svg>
                                    Fuel Stations ({{ route_data.petrol_bunks|length }})
                                </h4>
                            </div>
                            <div class="card-body p-2">
                                {% if route_data.petrol_bunks %}
                                {% for name, location in route_data.petrol_bunks.items() %}
                                {% if loop.index <= 5 %}
                                <div class="mb-2">
                                    <div class="small fw-bold">{{ name[:30] }}{% if name|length > 30 %}...{% endif %}</div>
                                    <div class="text-muted small">{{ location[:40] }}{% if location|length > 40 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% if route_data.petrol_bunks|length > 5 %}
                                <div class="text-muted small">... and {{ route_data.petrol_bunks|length - 5 }} more</div>
                                {% endif %}
                                {% else %}
                                <div class="text-muted small">None found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Schools -->
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title text-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                        <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                                    </svg>
                                    Schools ({{ route_data.schools|length }})
                                </h4>
                            </div>
                            <div class="card-body p-2">
                                {% if route_data.schools %}
                                {% for name, location in route_data.schools.items() %}
                                {% if loop.index <= 5 %}
                                <div class="mb-2">
                                    <div class="small fw-bold">{{ name[:30] }}{% if name|length > 30 %}...{% endif %}</div>
                                    <div class="text-muted small">{{ location[:40] }}{% if location|length > 40 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% if route_data.schools|length > 5 %}
                                <div class="text-muted small">... and {{ route_data.schools|length - 5 }} more</div>
                                {% endif %}
                                {% else %}
                                <div class="text-muted small">None found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Food Stops -->
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                        <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                                        <line x1="6" y1="1" x2="6" y2="4"/>
                                        <line x1="10" y1="1" x2="10" y2="4"/>
                                        <line x1="14" y1="1" x2="14" y2="4"/>
                                    </svg>
                                    Restaurants ({{ route_data.food_stops|length }})
                                </h4>
                            </div>
                            <div class="card-body p-2">
                                {% if route_data.food_stops %}
                                {% for name, location in route_data.food_stops.items() %}
                                {% if loop.index <= 5 %}
                                <div class="mb-2">
                                    <div class="small fw-bold">{{ name[:30] }}{% if name|length > 30 %}...{% endif %}</div>
                                    <div class="text-muted small">{{ location[:40] }}{% if location|length > 40 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% if route_data.food_stops|length > 5 %}
                                <div class="text-muted small">... and {{ route_data.food_stops|length - 5 }} more</div>
                                {% endif %}
                                {% else %}
                                <div class="text-muted small">None found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Coverage Dead Zones Alert -->
    {% if route_data.network_coverage.dead_zones %}
    <div class="col-12">
        <div class="alert alert-danger" role="alert">
            <div class="d-flex">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div>
                    <h4 class="alert-title">🆕 CRITICAL: Network Dead Zones Detected!</h4>
                    <div class="text-muted">
                        <strong>{{ route_data.network_coverage.dead_zones|length }} area(s)</strong> with no cellular coverage detected along your route.
                        This means emergency calls may not be possible in these locations.
                    </div>
                    <div class="mt-2">
                        <strong>Enhanced Safety Recommendations:</strong>
                        <ul class="mb-0">
                            <li>Inform contacts about communication blackouts at specific locations</li>
                            <li>Download offline maps before travel (see comprehensive map above)</li>
                            <li>Carry alternative communication devices if available</li>
                            <li>Plan emergency contact procedures for dead zones</li>
                            <li>Travel with companions when possible in these areas</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Poor Coverage Zones Warning -->
    {% if route_data.network_coverage.poor_zones %}
    <div class="col-12">
        <div class="alert alert-warning" role="alert">
            <div class="d-flex">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                    </svg>
                </div>
                <div>
                    <h4 class="alert-title">🆕 WARNING: Poor Coverage Areas Detected</h4>
                    <div class="text-muted">
                        <strong>{{ route_data.network_coverage.poor_zones|length }} area(s)</strong> with poor cellular coverage detected.
                        Communication may be unreliable in these zones.
                    </div>
                    <div class="mt-2">
                        <strong>Enhanced Precautions:</strong>
                        <ul class="mb-0">
                            <li>Download important documents offline before entering these areas</li>
                            <li>Send location updates before entering poor coverage zones</li>
                            <li>Keep devices charged with power banks ready</li>
                            <li>Use WiFi calling when available at rest stops</li>
                            <li>Allow extra time for communications in these zones</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Network Coverage Recommendations -->
    {% if route_data.network_coverage.recommendations %}
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M9 11H1l6-6v4a9.02 9.02 0 0 1 7.834 4.66"/>
                        <path d="M15 13h8l-6 6v-4A9.02 9.02 0 0 1 8.166 10.34"/>
                    </svg>
                    🆕 Enhanced Network Coverage Recommendations
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for recommendation in route_data.network_coverage.recommendations %}
                    <div class="col-md-6 mb-3">
                        <div class="card {% if recommendation.type == 'critical' %}border-danger{% elif recommendation.type == 'warning' %}border-warning{% elif recommendation.type == 'success' %}border-success{% else %}border-info{% endif %}">
                            <div class="card-header">
                                <h5 class="card-title {% if recommendation.type == 'critical' %}text-danger{% elif recommendation.type == 'warning' %}text-warning{% elif recommendation.type == 'success' %}text-success{% else %}text-info{% endif %}">
                                    {{ recommendation.title }}
                                </h5>
                            </div>
                            <div class="card-body p-3">
                                <p class="text-muted">{{ recommendation.description }}</p>
                                <ul class="mb-0">
                                    {% for action in recommendation.actions %}
                                    <li>{{ action }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Enhanced Safety Summary -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Enhanced Safety Summary & Recommendations
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4>Enhanced Pre-Journey Checklist</h4>
                        <ul>
                            <li><strong>📱 Download offline maps</strong> for the entire route (especially for {{ route_data.network_coverage.dead_zones|length }} dead zones)</li>
                            <li><strong>🔔 Inform contacts</strong> of your travel plans, timeline, and network blackout areas</li>
                            <li><strong>🔋 Charge all devices</strong> and carry power banks (critical for {{ route_data.network_coverage.poor_zones|length }} poor coverage areas)</li>
                            <li><strong>⚠️ Review {{ route_data.enhanced_stats.blind_spots_count }} blind spots</strong> - EXTREME CAUTION required</li>
                            <li><strong>🌤️ Check weather conditions</strong> at departure ({{ route_data.weather|length }} weather points monitored)</li>
                            <li><strong>⛽ Plan fuel stops</strong> - {{ route_data.petrol_bunks|length }} stations identified along route</li>
                            <li><strong>🏥 Note hospital locations</strong> - {{ route_data.hospitals|length }} facilities mapped for emergencies</li>
                            <li><strong>🏫 School zone awareness</strong> - {{ route_data.schools|length }} schools require 40 km/h speed limit</li>
                        </ul>

                        <h4 class="mt-4">Enhanced During Travel Guidelines</h4>
                        <ul>
                            <li><strong>🐌 CRAWL SPEED at blind spots</strong> - {{ route_data.enhanced_stats.blind_spots_count }} locations require 15-20 km/h</li>
                            <li><strong>📯 Use horns</strong> on all turns >70° ({{ route_data.enhanced_stats.sharp_danger_count }} high-danger turns)</li>
                            <li><strong>🚗 Maintain safe following distance</strong> - especially in poor visibility areas</li>
                            <li><strong>🏫 Observe school zone speeds</strong> - mandatory 40 km/h near {{ route_data.schools|length }} schools</li>
                            <li><strong>📡 Monitor signal strength</strong> and send updates when possible ({{ coverage_stats.api_success_rate|round(1) }}% coverage success rate)</li>
                            <li><strong>⚠️ Stay alert in {{ route_data.network_coverage.dead_zones|length }} network dead zones</strong> - no emergency calls possible</li>
                            <li><strong>🔋 Preserve battery</strong> in {{ route_data.network_coverage.poor_zones|length }} poor coverage areas</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5>Enhanced Route Statistics</h5>
                                <ul class="list-unstyled">
                                    <li><strong>Distance:</strong> {{ route_data.distance }}</li>
                                    <li><strong>Duration:</strong> {{ route_data.duration }}</li>
                                    <li><strong>Safety Score:</strong> 
                                        <span class="badge bg-{% if route_data.enhanced_stats.safety_score >= 85 %}success{% elif route_data.enhanced_stats.safety_score >= 70 %}warning{% else %}danger{% endif %}">
                                            {{ route_data.enhanced_stats.safety_score }}/100
                                        </span>
                                    </li>
                                    <li><strong>Critical Alerts:</strong> {{ route_data.enhanced_stats.total_critical_alerts }}</li>
                                    <li><strong>Network Reliability:</strong> 
                                        <span class="badge bg-{% if route_data.enhanced_stats.network_reliability == 'HIGH' %}success{% elif route_data.enhanced_stats.network_reliability == 'MEDIUM' %}warning{% else %}danger{% endif %}">
                                            {{ route_data.enhanced_stats.network_reliability }}
                                        </span>
                                    </li>
                                </ul>
                                
                                <h5 class="mt-3">Emergency Contacts</h5>
                                <ul class="list-unstyled">
                                    <li><strong>Police:</strong> 100</li>
                                    <li><strong>Medical:</strong> 108</li>
                                    <li><strong>Fire:</strong> 101</li>
                                    <li><strong>Emergency:</strong> 112</li>
                                </ul>

                                <h5 class="mt-3">Enhancement Features</h5>
                                <ul class="list-unstyled">
                                    <li>✅ Comprehensive mapping</li>
                                    <li>✅ Network coverage analysis</li>
                                    <li>✅ Real-time data integration</li>
                                    <li>✅ Enhanced safety scoring</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Google Maps initialization with comprehensive mapping
function initMaps() {
    const routePoints = {{ route_data.route_points|tojson }};
    const sharpTurns = {{ route_data.sharp_turns|tojson }};
    const networkCoverage = {{ route_data.network_coverage.coverage_analysis|tojson }};
    const deadZones = {{ route_data.network_coverage.dead_zones|tojson }};
    const poorZones = {{ route_data.network_coverage.poor_zones|tojson }};
    const pois = {
        hospitals: {{ route_data.hospitals|tojson }},
        petrol_bunks: {{ route_data.petrol_bunks|tojson }},
        schools: {{ route_data.schools|tojson }},
        food_stops: {{ route_data.food_stops|tojson }},
        police_stations: {{ route_data.police_stations|tojson }}
    };
    const elevation = {{ route_data.elevation|tojson }};
    
    // Initialize Enhanced Comprehensive Route Map
    initComprehensiveRouteMap(routePoints, sharpTurns, pois, elevation, deadZones, poorZones);
    
    // Initialize Dedicated Network Coverage Map
    initDedicatedNetworkCoverageMap(routePoints, networkCoverage, deadZones, poorZones);
}

function initComprehensiveRouteMap(routePoints, sharpTurns, pois, elevation, deadZones, poorZones) {
    if (!routePoints || routePoints.length === 0) return;
    
    const map = new google.maps.Map(document.getElementById('comprehensive-route-map'), {
        zoom: 10,
        center: { lat: routePoints[0][0], lng: routePoints[0][1] },
        mapTypeId: 'roadmap'
    });
    
    // Create route polyline
    const routePath = new google.maps.Polyline({
        path: routePoints.map(point => ({ lat: point[0], lng: point[1] })),
        geodesic: true,
        strokeColor: '#1f2937',
        strokeOpacity: 0.8,
        strokeWeight: 4
    });
    routePath.setMap(map);
    
    // Add start and end markers
    addStartEndMarkers(map, routePoints);
    
    // Add sharp turn markers with angle-based colors
    addSharpTurnMarkers(map, sharpTurns);
    
    // Add POI markers distributed along route
    addDistributedPOIMarkers(map, routePoints, pois);
    
    // Add elevation markers
    addElevationMarkers(map, elevation);
    
    // Add network dead zones
    addNetworkZoneMarkers(map, deadZones, poorZones);
    
    // Fit map to show all markers
    const bounds = new google.maps.LatLngBounds();
    routePoints.forEach(point => bounds.extend({ lat: point[0], lng: point[1] }));
    map.fitBounds(bounds);
}

function addStartEndMarkers(map, routePoints) {
    // Start marker (green)
    new google.maps.Marker({
        position: { lat: routePoints[0][0], lng: routePoints[0][1] },
        map: map,
        title: 'Route Start',
        icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#28a745">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3" fill="white"/>
                    <text x="12" y="14" text-anchor="middle" fill="white" font-size="8" font-weight="bold">S</text>
                </svg>
            `),
            scaledSize: new google.maps.Size(32, 32)
        }
    });
    
    // End marker (red)
    new google.maps.Marker({
        position: { lat: routePoints[routePoints.length-1][0], lng: routePoints[routePoints.length-1][1] },
        map: map,
        title: 'Route End',
        icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#dc3545">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3" fill="white"/>
                    <text x="12" y="14" text-anchor="middle" fill="white" font-size="8" font-weight="bold">E</text>
                </svg>
            `),
            scaledSize: new google.maps.Size(32, 32)
        }
    });
}

function addSharpTurnMarkers(map, sharpTurns) {
    sharpTurns.forEach((turn, index) => {
        const angle = turn.angle || 0;
        let color, label, title;
        
        if (angle > 80) {
            color = '#8b0000'; // Dark red for blind spots
            label = `B${index + 1}`;
            title = `BLIND SPOT ${index + 1}: ${angle}° - EXTREME DANGER`;
        } else if (angle >= 70) {
            color = '#dc3545'; // Red for sharp turns
            label = `S${index + 1}`;
            title = `SHARP TURN ${index + 1}: ${angle}° - HIGH DANGER`;
        } else {
            color = '#fd7e14'; // Orange for moderate turns
            label = `M${index + 1}`;
            title = `MODERATE TURN ${index + 1}: ${angle}° - CAUTION`;
        }
        
        new google.maps.Marker({
            position: { lat: turn.lat, lng: turn.lng },
            map: map,
            title: title,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="${color}">
                        <path d="M12 2L2 22h20L12 2z"/>
                        <text x="12" y="16" text-anchor="middle" fill="white" font-size="6" font-weight="bold">${label}</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(28, 28)
            }
        });
    });
}

function addDistributedPOIMarkers(map, routePoints, pois) {
    const routeLength = routePoints.length;
    
    // Hospitals (blue markers)
    Object.keys(pois.hospitals).slice(0, 4).forEach((hospital, index) => {
        const pointIndex = Math.min(index * Math.floor(routeLength / 4), routeLength - 1);
        const point = routePoints[pointIndex];
        
        new google.maps.Marker({
            position: { lat: point[0] + 0.002, lng: point[1] + 0.002 },
            map: map,
            title: `Hospital: ${hospital}`,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#0891b2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <path d="M12 6v6m-3-3h6" stroke="white" stroke-width="2"/>
                        <text x="12" y="20" text-anchor="middle" fill="black" font-size="6">H${index + 1}</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
    });
    
    // Petrol bunks (purple markers)
    Object.keys(pois.petrol_bunks).slice(0, 3).forEach((station, index) => {
        const pointIndex = Math.min((index + 1) * Math.floor(routeLength / 3), routeLength - 1);
        const point = routePoints[pointIndex];
        
        new google.maps.Marker({
            position: { lat: point[0] - 0.002, lng: point[1] + 0.002 },
            map: map,
            title: `Fuel Station: ${station}`,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#7c3aed">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <path d="M9 7h6v6H9z" fill="white"/>
                        <text x="12" y="20" text-anchor="middle" fill="black" font-size="6">F${index + 1}</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
    });
    
    // Schools (yellow markers)
    Object.keys(pois.schools).slice(0, 3).forEach((school, index) => {
        const pointIndex = Math.min((index + 2) * Math.floor(routeLength / 5), routeLength - 1);
        const point = routePoints[pointIndex];
        
        new google.maps.Marker({
            position: { lat: point[0] + 0.001, lng: point[1] - 0.002 },
            map: map,
            title: `School: ${school} - Speed Limit 40 km/h`,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#ffc107">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <path d="M8 8h8v6H8z" fill="white"/>
                        <text x="12" y="20" text-anchor="middle" fill="black" font-size="5">SC${index + 1}</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24)
            }
        });
    });
}

function addElevationMarkers(map, elevation) {
    elevation.slice(0, 8).forEach((elev, index) => {
        const location = elev.location;
        const elevationValue = elev.elevation || 0;
        
        if (location && location.lat && location.lng) {
            const isHigh = elevationValue > 1000;
            const color = isHigh ? '#8b4513' : '#90ee90';
            const label = isHigh ? `H${index + 1}` : `L${index + 1}`;
            
            new google.maps.Marker({
                position: { lat: location.lat, lng: location.lng },
                map: map,
                title: `Elevation: ${elevationValue.toFixed(1)}m`,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${color}">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <text x="12" y="14" text-anchor="middle" fill="white" font-size="7">${label}</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(20, 20)
                }
            });
        }
    });
}

function addNetworkZoneMarkers(map, deadZones, poorZones) {
    // Dead zones (gray markers)
    deadZones.slice(0, 5).forEach((zone, index) => {
        const coords = extractCoordinates(zone);
        if (coords) {
            new google.maps.Marker({
                position: { lat: coords.lat, lng: coords.lng },
                map: map,
                title: `Network Dead Zone ${index + 1} - No cellular coverage`,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="#6b7280">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <text x="12" y="14" text-anchor="middle" fill="white" font-size="6">D${index + 1}</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(22, 22)
                }
            });
        }
    });
    
    // Poor coverage zones (pink markers)
    poorZones.slice(0, 3).forEach((zone, index) => {
        const coords = extractCoordinates(zone);
        if (coords) {
            new google.maps.Marker({
                position: { lat: coords.lat, lng: coords.lng },
                map: map,
                title: `Poor Network Coverage ${index + 1} - Unreliable connectivity`,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#ec4899">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <text x="12" y="14" text-anchor="middle" fill="white" font-size="6">P${index + 1}</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(20, 20)
                }
            });
        }
    });
}

function initDedicatedNetworkCoverageMap(routePoints, networkCoverage, deadZones, poorZones) {
    if (!routePoints || routePoints.length === 0) return;
    
    const map = new google.maps.Map(document.getElementById('network-coverage-map'), {
        zoom: 10,
        center: { lat: routePoints[0][0], lng: routePoints[0][1] },
        mapTypeId: 'roadmap'
    });
    
    // Create route polyline (thinner for network focus)
    const routePath = new google.maps.Polyline({
        path: routePoints.map(point => ({ lat: point[0], lng: point[1] })),
        geodesic: true,
        strokeColor: '#6b7280',
        strokeOpacity: 0.6,
        strokeWeight: 3
    });
    routePath.setMap(map);
    
    // Add network coverage points with quality-based colors
    networkCoverage.forEach((point, index) => {
        const coords = point.coordinates;
        const quality = point.coverage_quality;
        
        if (coords && coords.lat && coords.lng) {
            let color, title;
            
            switch(quality) {
                case 'excellent':
                    color = '#059669';
                    title = `Excellent Coverage - Point ${index + 1}`;
                    break;
                case 'good':
                    color = '#10b981';
                    title = `Good Coverage - Point ${index + 1}`;
                    break;
                case 'fair':
                    color = '#f59e0b';
                    title = `Fair Coverage - Point ${index + 1}`;
                    break;
                case 'poor':
                    color = '#f97316';
                    title = `Poor Coverage - Point ${index + 1}`;
                    break;
                case 'dead':
                    color = '#dc2626';
                    title = `Dead Zone - Point ${index + 1}`;
                    break;
                default:
                    color = '#6b7280';
                    title = `Coverage Unknown - Point ${index + 1}`;
            }
            
            // Create coverage circles
            new google.maps.Circle({
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.35,
                map: map,
                center: { lat: coords.lat, lng: coords.lng },
                radius: 500 // 500 meter radius
            });
            
            // Add markers for critical areas
            if (quality === 'dead' || quality === 'poor') {
                new google.maps.Marker({
                    position: { lat: coords.lat, lng: coords.lng },
                    map: map,
                    title: title,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${color}">
                                <circle cx="12" cy="12" r="10"/>
                                <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">!</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(18, 18)
                    }
                });
            }
        }
    });
    
    // Fit map to show all points
    const bounds = new google.maps.LatLngBounds();
    routePoints.forEach(point => bounds.extend({ lat: point[0], lng: point[1] }));
    map.fitBounds(bounds);
}

function extractCoordinates(zone) {
    if (zone.coordinates) return zone.coordinates;
    if (zone.start_coordinates) return zone.start_coordinates;
    return null;
}

// Enhanced utility functions
function toggleMapFullscreen(mapId) {
    const mapElement = document.getElementById(mapId);
    const isFullscreen = mapElement.classList.contains('fullscreen-map');
    
    if (isFullscreen) {
        mapElement.classList.remove('fullscreen-map');
        mapElement.style.position = 'relative';
        mapElement.style.top = 'auto';
        mapElement.style.left = 'auto';
        mapElement.style.width = '100%';
        mapElement.style.height = '500px';
        mapElement.style.zIndex = 'auto';
        mapElement.style.backgroundColor = 'transparent';
    } else {
        mapElement.classList.add('fullscreen-map');
        mapElement.style.position = 'fixed';
        mapElement.style.top = '0';
        mapElement.style.left = '0';
        mapElement.style.width = '100vw';
        mapElement.style.height = '100vh';
        mapElement.style.zIndex = '9999';
        mapElement.style.backgroundColor = 'white';
    }
    
    // Trigger map resize
    setTimeout(() => {
        google.maps.event.trigger(window, 'resize');
    }, 100);
}

function downloadMapImage(mapId) {
    // This would require additional libraries like html2canvas
    alert('Map download feature requires additional setup. Please use browser screenshot for now.');
}

function refreshNetworkData() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin"><path d="M3 12a9 9 0 0118 0 9 9 0 01-18 0z"/><path d="M12 3v9l3 3"/></svg> Refreshing...';
    btn.disabled = true;
    
    // Simulate network data refresh
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Show refresh notification
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible';
        alert.innerHTML = `
            <div class="d-flex">
                <div>📡</div>
                <div>
                    <h4 class="alert-title">Network Data Refreshed</h4>
                    <div class="text-muted">Latest network coverage data has been updated.</div>
                </div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert"></a>
        `;
        
        document.querySelector('.container-xl').insertBefore(alert, document.querySelector('.row'));
        
        setTimeout(() => alert.remove(), 5000);
    }, 2000);
}

// CSS for fullscreen maps
const style = document.createElement('style');
style.textContent = `
    .fullscreen-map {
        transition: all 0.3s ease;
    }
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Load Google Maps API
function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMaps`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', loadGoogleMaps);
</script>
{% endblock %}